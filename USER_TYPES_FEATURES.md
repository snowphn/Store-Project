# 用户类型和邀请码特权功能说明

## 功能概述

本次更新为系统添加了完整的用户类型管理和邀请码特权功能，实现了用户权限的精细化管理和自动化账户类型检测。

## 主要功能

### 1. 邀请码特权选择

#### 特权类型
- **普通用户** (normal): 基础权限，可以浏览商品、购买商品
- **VIP用户** (vip): 增强权限，享受特殊优惠和服务
- **管理员** (admin): 完整管理权限，可以管理用户、商品、订单等

#### 管理员功能
- 在管理员界面可以选择生成不同特权类型的邀请码
- 邀请码列表显示特权类型、使用状态和创建时间
- 支持删除已使用的邀请码

### 2. 用户注册机制

#### 邀请码注册
- 用户输入有效邀请码时，系统自动检测并显示对应的账户类型
- 注册成功后，用户获得邀请码对应的特权等级
- 邀请码使用后自动标记为已使用，记录使用者信息

#### 无邀请码注册
- 用户不填写邀请码时，自动注册为普通用户
- 保证系统的开放性，同时维护特权用户的独特性

### 3. 用户类型自动检测和命名系统

#### 显示名称生成
- 系统根据用户类型自动生成显示名称
- 格式：`{用户类型} - {用户名}`
- 例如："VIP用户 - alice"、"管理员 - admin"

#### 权限自动设置
- 管理员类型用户自动获得 `is_admin = True`
- 系统根据用户类型自动分配相应权限

## 数据库结构更新

### InviteCode 表新增字段
```sql
- privilege_type: 特权类型 (normal/vip/admin)
- used_by_user_id: 使用该邀请码的用户ID
```

### User 表新增字段
```sql
- user_type: 用户类型 (normal/vip/admin)
- display_name: 显示名称
- invite_code_used: 使用的邀请码
```

## 界面更新

### 管理员界面
- 邀请码生成支持特权选择对话框
- 邀请码列表显示特权类型
- 用户列表显示用户类型、显示名称和使用的邀请码

### 注册界面
- 邀请码输入框支持实时类型检测
- 动态显示将要注册的账户类型
- 提示信息更加友好和详细

### 用户资料界面
- 显示用户类型和显示名称
- 根据用户等级使用不同的样式和颜色

## 使用指南

### 管理员操作

1. **生成邀请码**
   - 进入管理员界面
   - 点击"生成邀请码"按钮
   - 选择要生成的特权类型
   - 确认生成

2. **管理邀请码**
   - 查看邀请码列表，包含特权类型和使用状态
   - 删除已使用的邀请码（可选）

3. **用户管理**
   - 查看用户类型和使用的邀请码
   - 根据用户类型进行相应管理

### 用户注册

1. **使用邀请码注册**
   - 填写基本信息
   - 输入邀请码（系统会自动检测类型）
   - 确认注册

2. **普通注册**
   - 填写基本信息
   - 不填写邀请码
   - 自动注册为普通用户

## 安全特性

- 邀请码一次性使用，防止重复利用
- 用户类型在注册时确定，后续不可随意更改
- 管理员权限严格控制，只能通过管理员邀请码获得
- 完整的使用记录，便于审计和管理

## 迁移说明

### 现有数据处理
- 现有管理员用户自动升级为管理员类型
- 现有普通用户保持普通用户类型
- 自动为所有用户生成显示名称

### 迁移步骤
1. 备份现有数据库
2. 运行迁移脚本：`python database/migrate_user_types.py`
3. 验证迁移结果
4. 测试新功能

## 测试验证

运行测试脚本验证功能：
```bash
python test_user_types.py
```

测试内容包括：
- 邀请码生成和特权设置
- 用户注册和类型分配
- 显示名称自动生成
- 权限自动设置
- 邀请码使用限制

## 扩展性

### 未来可扩展功能
- 更多用户类型（如高级VIP、超级管理员等）
- 用户类型升级/降级机制
- 基于用户类型的个性化界面
- 用户类型相关的积分奖励机制
- 批量邀请码生成

### 配置选项
- 用户类型权限配置
- 显示名称格式自定义
- 邀请码有效期设置
- 注册策略配置（是否允许无邀请码注册）

## 注意事项

1. **数据备份**: 升级前务必备份数据库
2. **权限测试**: 升级后测试各类型用户的权限是否正确
3. **界面兼容**: 确保所有界面正确显示新的用户信息
4. **性能影响**: 新增字段对查询性能的影响微乎其微

## 技术实现

### 核心组件
- `models/invite_code.py`: 邀请码模型和特权类型枚举
- `models/user.py`: 用户模型和类型管理方法
- `database/db_operations.py`: 数据库操作函数
- `views/admin_view.py`: 管理员界面更新
- `views/register_view.py`: 注册界面更新
- `views/user_profile_view.py`: 用户资料界面更新

### 设计模式
- 枚举类型确保数据一致性
- 模型方法封装业务逻辑
- 数据库操作统一管理
- 界面组件模块化设计

这套用户类型和邀请码特权系统为应用提供了完整的用户权限管理基础，支持灵活的扩展和定制。